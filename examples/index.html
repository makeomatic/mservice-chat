<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Example chat</title>
</head>
<body>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script>
  //var socket = io('http://localhost:3000/simpleChat', { query: 'token=myJWT' });
  var socket = io('http://localhost:3000/simpleChat');

  function appendMessage(message) {
    document.body.innerHTML += '<div>' + message + '</div>'
  }

  function execute(event) {
    var actions = {
      '/j': function(id) {
        socket.emit('rooms.join', { id: id }, response('rooms.join'));
      },
      '/l': function(id) {
        socket.emit('rooms.leave', { id: id }, response('rooms.leave'));
      },
    };

    function parse(command) {
      var commands = command.split(' ');
      actions[commands[0]](commands.slice(1).join(' '));
    }

    event = event || window.event;

    if (event.keyCode === 13) {
      var element = event.srcElement || event.target;
      parse(element.value);
      element.value = null;
    }
  }

  function response(action) {
    var actions = {
      me: function(user) {
        appendMessage('Nice to see you  ' + user.name)
      },
      'rooms.list': function(rooms) {
        appendMessage('Available rooms:');
        rooms.forEach(function(room) {
          appendMessage('#(' + room.id + '): <b>' + room.name + '</b>')
        });
        appendMessage('Try /j room.id');
        appendMessage('<input id="input" onkeydown="execute()" placeholder="text me" autofocus />');
      },
      'rooms.join': function(room) {
        appendMessage('You join to room ' + room.name);
      },
      'rooms.leave': function(room) {
        appendMessage('You left room ' + room.name);
      }
    };

    return function dispatch(error, data) {
      if (error) {
        return console.error(error);
      }

      actions[action](data);
    }
  }

  socket.on('error', function(error) {
    console.error(error);
  });

  socket.on('rooms.join', function(data) {
    appendMessage('User ' + data.user.name + ' joined room ' + data.room.name);
  });

  socket.on('rooms.leave', function(data) {
    appendMessage('User ' + data.user.name + ' left room ' + data.room.name);
  });

  socket.on('connect', function() {
    socket.emit('me', {}, response('me'))
      .emit('rooms.list', {}, response('rooms.list'));
  });

  socket.on('disconnect', function() {
    document.body.innerHTML = '<div>Disconnect from server</div>'
  });
</script>
</body>
</html>
